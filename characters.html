<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="stylesheets/stylesheet.css" media="screen">
</head>
<body>

<section>
    <article>
        <script id="scores-template" type="text/x-handlebars-template">
            <div class="attempt-{{attempt}}" id="scores">
                    <span>{{score}}</span>
            </div>
        </script>

        <script id="key-template" type="text/x-handlebars-template">
            <div id="key" class="{{type}}">
                <span id="keydisplay">{{character}}</span>
            </div>
        </script>
    </article>
</section>

<script src="scripts/jquery-1.8.2.min.js"></script>
<script src="scripts/handlebars-1.0.rc.1.js"></script>
<script src="scripts/underscore-min.js"></script>
<script src="scripts/backbone-min.js"></script>

<script>
(function () {
    var AppRouter, app_router, FlashcardModel, ScoresView, FlashcardView, PageView, FlashcardCollection, cardCollection, addCards;

    FlashcardModel = Backbone.Model.extend({
        defaults: {
            success: 0,
            failure: 0,
            type: '',
            character: ''
        },

        getScore: function() {
            return this.get('success') - this.get('failure');
        }
    });

    ScoresView = Backbone.View.extend({
        template: Handlebars.compile($("#scores-template").html()),

        initialize: function() {
            this.collection.bind('change', this.render, this);
            this.render();
        },

        render: function() {
            var templateResult = this.template({
                score : this.collection.getScore(),
                attempt : this.collection.attempt
            });
            $(this.el).empty();
            $(this.el).append(templateResult);
            return this;
        }
    })

    FlashcardView = Backbone.View.extend({
        template: Handlebars.compile($("#key-template").html()),

        initialize: function () {
            this.render();
        },

        render: function () {
            var templateResult = this.template(this.model.toJSON());
            $(this.el).append(templateResult);
            return this;
        }
    });

    PageView = Backbone.View.extend({
        initialize: function () {
            var self, scoresView, keyReleased;

            keyReleased = true;

            self = this;
            $(document).keydown('keydown.flashcard', function (e) {
                var code, character;
                e.preventDefault();
                if (keyReleased) {
                    keyReleased = false;
                    code = (e.keyCode ? e.keyCode : e.which);
                    character = String.fromCharCode(code);
                    if (self.collection.get(character)) {
                        self.collection.attempt++;
                        if (self.updateScore(character)) {
                            self.displayNewCard();
                        }
                        scoresView.render();
                    }
                }
            });

            $(document).keyup('keyup.flashcard', function (e) {
                keyReleased = true;
            });

            scoresView = new ScoresView({
                collection : cardCollection
            })

            this.$el.append(scoresView.el);
        },

        updateScore: function(characterPressed) {
            var success, failure;
            if (characterPressed === this.currentView.model.get('character')) {
                success = this.currentView.model.get('success')+1;
                this.currentView.model.set('success',success);
                this.collection.sort();
                return true;
            }
            else {
                if (this.collection.attempt === 1) {
                    failure = this.currentView.model.get('failure')+1;
                    this.currentView.model.set('failure',failure);
                    this.collection.sort();
                } else if (this.collection.attempt > 2) {
                    return true;
                }
                return false;
            }
        },

        displayNewCard: function() {
            var newCardModel = this.collection.getNextCard();
            if (newCardModel) {
                this.replaceCard(newCardModel);
            }
        },

        replaceCard: function(newCardModel) {
            var newCardView;
            
            newCardView = new FlashcardView({
                model: newCardModel
            });

            if (this.currentView) {
                this.currentView.remove();
            }
            this.currentView = newCardView;
            this.$el.append(newCardView.el);
        }
    });

    FlashcardCollection = Backbone.Collection.extend({
        model: FlashcardModel,

        attempt : 0,

        getScore : function() {
            var score = 0;
            this.each(function(model) {
                score += model.getScore();
            });
            return score;
        },

		comparator : function(modelA, modelB) {
			var a,b;
			if (modelA && modelB) {
			    a = modelA.getScore();
			    b = modelB.getScore();
				if ( a < b ) {
					return -1;
				}
				if ( a > b ) {
					return 1;
				}
			}
			return 0;
		},
		
        getNextCard: function() {
            var nextId;
            nextId=Math.floor(Math.pow(Math.random(),1.5)*this.length)
            this.attempt = 0;
            return this.at(nextId);
        }
    });

    cardCollection = new FlashcardCollection();

    addCards = function(letters, style) {
        letters.split('').forEach( function (c) {
            var cardModel = new FlashcardModel({
                type: style,
                character: c,
                id: c
            });

            cardCollection.add(cardModel);
        });
    };

    pageView = new PageView({
        el : 'article',
        collection : cardCollection
    });

    AppRouter = Backbone.Router.extend({
        routes: {
            'characters' : 'characters',
            'numbers' : 'numbers',
            ''  : 'all'
        }
    });

    app_router = new AppRouter();

    app_router.on('route:characters',function() {
        cardCollection.reset();
        addCards('BCDFGHJKLMNPQRSTVWXYZ','consonant');
        addCards('AEIOU','vowel');
        pageView.displayNewCard();
    });

    app_router.on('route:numbers', function() {
        cardCollection.reset();
        addCards('0123456789','number');
        pageView.displayNewCard();
    });

    app_router.on('route:all', function() {
        cardCollection.reset();
        addCards('BCDFGHJKLMNPQRSTVWXYZ','consonant');
        addCards('AEIOU','vowel');
        addCards('0123456789','number');
        pageView.displayNewCard();
    });

    pageView.render();

    Backbone.history.start({pushState: true});

    app_router.navigate('',{trigger: false});
})();
</script> 
</body>
</html>
